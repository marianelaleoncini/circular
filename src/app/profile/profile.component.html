<mat-toolbar>
  <button mat-icon-button class="example-icon" aria-label="arrow back" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <span>Perfil</span>
</mat-toolbar>

<div class="profile">
  <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="profile-form">
    
    <div class="profile-header">
      <h2>Editar Perfil</h2>
      <button mat-button class="logout-button" aria-label="Cerrar sesiÃ³n" (click)="logout()">
        <mat-icon>logout</mat-icon>
      </button>
    </div>

    <div class="avatar-wrapper">
      <div class="avatar-container" (click)="fileInput.click()">
        <img 
          [src]="(imageUrl || user?.photoURL) ? (imageUrl || user?.photoURL) : 'assets/images/user-placeholder.png'" 
          class="profile-image" 
          alt="Foto de perfil"
        />
        
        <div class="loading-overlay" *ngIf="uploadingImage">
          <mat-spinner diameter="40" color="accent"></mat-spinner>
        </div>

        <button 
          mat-mini-fab 
          color="primary" 
          class="edit-btn" 
          type="button"
          [disabled]="uploadingImage">
          <mat-icon>edit</mat-icon> 
        </button>
      </div>

      <p class="change-photo-text">Cambiar foto</p>
    </div>

    <input #fileInput type="file" hidden (change)="onFileSelected($event)" accept="image/*" />

    <mat-form-field appearance="fill">
      <mat-label>Nombre</mat-label>
      <input matInput formControlName="name" required />
      <mat-error *ngIf="profileForm.get('name')?.invalid">El nombre es obligatorio</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Provincia</mat-label>
      <mat-select formControlName="province">
        <mat-option *ngFor="let province of provinces" [value]="province.id">
          {{ province.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Ciudad</mat-label>
      <mat-select formControlName="city">
        <mat-option *ngFor="let city of cities" [value]="city.id">
          {{ city.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" [disabled]="isLoading" type="submit" class="save-btn">
      <mat-progress-spinner *ngIf="isLoading" mode="indeterminate" diameter="24" color="accent"></mat-progress-spinner>
      <span *ngIf="!isLoading">Guardar</span>
    </button>
  </form>
</div>